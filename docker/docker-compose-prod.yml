version: "3.2"
services:
  react:
    image: react-prod
    build:
      context: ../
      dockerfile: docker/react/Dockerfile-prod
    ports:
      - "1337"
    environment:
      - HOST=localhost
      - PORT=1337
      - REACT_COPY_STATIC=on
      - INSTANCES=1
    command: /usr/local/bin/pm2-docker start react.config.js
    volumes:
      - type: volume
        source: static
        target: /static
  django:
    image: django-prod
    build:
      context: ../
      dockerfile: docker/django/Dockerfile-prod
    ports:
      - "8000:8000"
  nginx:
    image: nginx:1.13.6-alpine
    environment:
     - NGINX_HOST=foobar.com
     - NGINX_PORT=80
    command: sh -c "cp /etc/nginx/conf.d/mysite.template /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    volumes:
      - type: bind
        source: ./nginx/mysite.template
        target: /etc/nginx/conf.d/mysite.template
      - type: bind
        source: ./nginx/uwsgi_params
        target: /etc/nginx/conf.d/uwsgi_params
      - type: volume
        source: static
        target: /static
    ports:
      - "80:80"
volumes:
  static:
